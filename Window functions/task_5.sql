-- Customer Lifetime Value and Average Lifetime Value for cohort year 2015

WITH yearly_cohort AS (
    SELECT 
      customerkey,
      EXTRACT(YEAR FROM MIN(orderdate)) AS cohort_year,
      SUM(quantity * netprice * exchangerate) AS customer_ltv
    FROM sales
    GROUP BY customerkey
)
SELECT *,
      AVG(customer_ltv) OVER(PARTITION BY cohort_year) AS avg_coort_ltv
FROM yearly_cohort
ORDER BY cohort_year, customerkey
LIMIT 100


/*
index,customerkey,cohort_year,customer_ltv,avg_coort_ltv
0,4376,"""2015""",182.00333778750002,5271.586007033075
1,4403,"""2015""",9530.349683958,5271.586007033075
2,4925,"""2015""",6078.08235892,5271.586007033075
3,5729,"""2015""",192.16384000000002,5271.586007033075
4,6048,"""2015""",1903.8940906279,5271.586007033075
5,6705,"""2015""",13133.760541200001,5271.586007033075
6,9440,"""2015""",208.00848487500002,5271.586007033075
7,10806,"""2015""",442.0924816,5271.586007033075
8,12116,"""2015""",9714.2939265,5271.586007033075
9,12973,"""2015""",253.06033200000002,5271.586007033075
10,14413,"""2015""",2557.6186603652504,5271.586007033075
11,14527,"""2015""",81.6544262604,5271.586007033075
12,18123,"""2015""",5936.105880855,5271.586007033075
13,19864,"""2015""",6592.292032910999,5271.586007033075
14,19883,"""2015""",19488.829710941,5271.586007033075
15,23698,"""2015""",4424.889153348,5271.586007033075
16,27951,"""2015""",963.4668048030001,5271.586007033075
17,28027,"""2015""",6269.4364551,5271.586007033075
18,32799,"""2015""",1972.0096982399998,5271.586007033075
19,32825,"""2015""",3675.005124588,5271.586007033075
20,33167,"""2015""",14005.5150936831,5271.586007033075
21,35592,"""2015""",44.09083278600001,5271.586007033075
22,35835,"""2015""",9572.1257513325,5271.586007033075
23,36764,"""2015""",12526.870123222501,5271.586007033075
24,39593,"""2015""",183.73743127999998,5271.586007033075
25,40710,"""2015""",4103.7678772605,5271.586007033075
26,42398,"""2015""",512.846208,5271.586007033075
27,43129,"""2015""",1556.199671751,5271.586007033075
28,43692,"""2015""",6799.033301400001,5271.586007033075
29,50035,"""2015""",2288.0872755299997,5271.586007033075
30,53834,"""2015""",504.602266896,5271.586007033075
31,55878,"""2015""",931.7384702025001,5271.586007033075
32,56698,"""2015""",376.0552953,5271.586007033075
33,56764,"""2015""",33279.1743595614,5271.586007033075
34,58329,"""2015""",1064.6004550116,5271.586007033075
35,58654,"""2015""",1694.6576846399998,5271.586007033075
36,59383,"""2015""",3251.708465272,5271.586007033075
37,60120,"""2015""",501.28717713599997,5271.586007033075
38,60236,"""2015""",11479.751857105599,5271.586007033075
39,62553,"""2015""",10648.272919691999,5271.586007033075
40,63449,"""2015""",15450.840629651999,5271.586007033075
41,63460,"""2015""",1849.4291568,5271.586007033075
42,64070,"""2015""",2946.7814154064004,5271.586007033075
43,65057,"""2015""",621.0624,5271.586007033075
44,68452,"""2015""",20409.290503154,5271.586007033075
45,68530,"""2015""",10086.884186776,5271.586007033075
46,72027,"""2015""",12132.104018633401,5271.586007033075
47,74368,"""2015""",26453.756744780003,5271.586007033075
48,75702,"""2015""",807.7203068202,5271.586007033075
49,77453,"""2015""",2390.41809766,5271.586007033075
50,78207,"""2015""",3739.3444034712,5271.586007033075
51,79386,"""2015""",4149.985983037001,5271.586007033075
52,79753,"""2015""",7269.12267444,5271.586007033075
53,80164,"""2015""",461.76742920000004,5271.586007033075
54,80326,"""2015""",1012.4058478016,5271.586007033075
55,80496,"""2015""",1050.1920781632,5271.586007033075
56,80581,"""2015""",16207.021821516002,5271.586007033075
57,81738,"""2015""",33336.9831014384,5271.586007033075
58,83077,"""2015""",17241.766129224,5271.586007033075
59,85479,"""2015""",11008.1030913924,5271.586007033075
60,85585,"""2015""",7016.54359032,5271.586007033075
61,86561,"""2015""",3192.0546538974,5271.586007033075
62,87540,"""2015""",6337.18662894736,5271.586007033075
63,87778,"""2015""",28767.860762734002,5271.586007033075
64,87997,"""2015""",14300.205263020001,5271.586007033075
65,89929,"""2015""",7133.500610114999,5271.586007033075
66,90523,"""2015""",4917.08663424,5271.586007033075
67,93396,"""2015""",829.52900778,5271.586007033075
68,94794,"""2015""",7215.676745394001,5271.586007033075
69,100322,"""2015""",1139.724768,5271.586007033075
70,100919,"""2015""",326.5741152,5271.586007033075
71,102590,"""2015""",2695.135897674,5271.586007033075
72,102845,"""2015""",16954.38830224,5271.586007033075
73,104299,"""2015""",7590.2536466076,5271.586007033075
74,106157,"""2015""",41.5869714,5271.586007033075
75,107717,"""2015""",1377.7305932250003,5271.586007033075
76,111037,"""2015""",3279.8725998500004,5271.586007033075
77,111481,"""2015""",123.67449599999999,5271.586007033075
78,115455,"""2015""",29205.60318933449,5271.586007033075
79,116924,"""2015""",7.084946360799999,5271.586007033075
80,118179,"""2015""",1358.2120266000002,5271.586007033075
81,118211,"""2015""",4511.85038724,5271.586007033075
82,119133,"""2015""",1998.8693261672001,5271.586007033075
83,120817,"""2015""",17495.1057312584,5271.586007033075
84,120914,"""2015""",424.2328455,5271.586007033075
85,122338,"""2015""",680.6870004,5271.586007033075
86,123799,"""2015""",3473.1791085120003,5271.586007033075
87,124839,"""2015""",2551.093872024,5271.586007033075
88,125943,"""2015""",20506.406866475998,5271.586007033075
89,126572,"""2015""",17121.8909439504,5271.586007033075
90,126921,"""2015""",213.80457384000002,5271.586007033075
91,127378,"""2015""",5475.174989760001,5271.586007033075
92,128048,"""2015""",323.62990946639997,5271.586007033075
93,128128,"""2015""",6306.519311399999,5271.586007033075
94,128305,"""2015""",7691.85154836,5271.586007033075
95,128946,"""2015""",6257.109935999999,5271.586007033075
96,129446,"""2015""",52.1107104,5271.586007033075
97,130500,"""2015""",6763.482488648318,5271.586007033075
98,133386,"""2015""",8341.54887928,5271.586007033075
99,134374,"""2015""",324.63105674999997,5271.586007033075
*/


