-- Unique customers per Year by Cohort

WITH yearly_cohort AS (
  SELECT DISTINCT
      customerkey,
      EXTRACT(YEAR FROM MIN(orderdate) OVER(PARTITION BY customerkey)) AS cohort_year,
      EXTRACT(YEAR FROM orderdate) AS purchase_year
  FROM sales
)

SELECT DISTINCT
    cohort_year,
    purchase_year,
    COUNT(customerkey) OVER(PARTITION BY purchase_year, cohort_year) AS num_customers
FROM yearly_cohort
ORDER BY cohort_year, purchase_year


/*
index,cohort_year,purchase_year,num_customers
0,"""2015""","""2015""",2825
1,"""2015""","""2016""",126
2,"""2015""","""2017""",149
3,"""2015""","""2018""",348
4,"""2015""","""2019""",388
5,"""2015""","""2020""",171
6,"""2015""","""2021""",295
7,"""2015""","""2022""",600
8,"""2015""","""2023""",499
9,"""2015""","""2024""",146
10,"""2016""","""2016""",3397
11,"""2016""","""2017""",174
12,"""2016""","""2018""",374
13,"""2016""","""2019""",457
14,"""2016""","""2020""",205
15,"""2016""","""2021""",336
16,"""2016""","""2022""",746
17,"""2016""","""2023""",573
18,"""2016""","""2024""",183
19,"""2017""","""2017""",4068
20,"""2017""","""2018""",473
21,"""2017""","""2019""",570
22,"""2017""","""2020""",251
23,"""2017""","""2021""",450
24,"""2017""","""2022""",943
25,"""2017""","""2023""",738
26,"""2017""","""2024""",246
27,"""2018""","""2018""",7446
28,"""2018""","""2019""",1081
29,"""2018""","""2020""",475
30,"""2018""","""2021""",779
31,"""2018""","""2022""",1644
32,"""2018""","""2023""",1407
33,"""2018""","""2024""",426
34,"""2019""","""2019""",7755
35,"""2019""","""2020""",523
36,"""2019""","""2021""",873
37,"""2019""","""2022""",1700
38,"""2019""","""2023""",1439
39,"""2019""","""2024""",370
*/