-- Month-over-month revenue growth


WITH monthly_revenue AS(
    SELECT 
        TO_CHAR(orderdate, 'YYYY-MM') AS month,
        SUM(quantity * netprice * exchangerate) AS net_revenue
    FROM sales
    WHERE EXTRACT(YEAR FROM orderdate) = 2023
    GROUP BY month
)

SELECT
    *,
    FIRST_VALUE(net_revenue) OVER(ORDER BY month) AS first_month_revenue,
    LAST_VALUE(net_revenue) OVER(ORDER BY month ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS last_month_revenue,
    NTH_VALUE(net_revenue, 3) OVER(ORDER BY month ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS third_month_revenue
FROM monthly_revenue


-- further version

WITH monthly_revenue AS(
    SELECT 
        TO_CHAR(orderdate, 'YYYY-MM') AS month,
        SUM(quantity * netprice * exchangerate) AS net_revenue
    FROM sales
    WHERE EXTRACT(YEAR FROM orderdate) = 2023
    GROUP BY month
)

SELECT
    *,
    LAG(net_revenue) OVER (ORDER BY month) AS previous_month_revenue,
    LEAD(net_revenue) OVER (ORDER BY month) AS next_month_revenue
FROM monthly_revenue


/*
index,month,net_revenue,first_month_revenue,last_month_revenue,third_month_revenue
0,2023-01,3664431.3447418325,3664431.3447418325,2928550.9251028164,2244316.5207615616
1,2023-02,4465204.568873988,3664431.3447418325,2928550.9251028164,2244316.5207615616
2,2023-03,2244316.5207615616,3664431.3447418325,2928550.9251028164,2244316.5207615616
3,2023-04,1162796.162295781,3664431.3447418325,2928550.9251028164,2244316.5207615616
4,2023-05,2943005.989718092,3664431.3447418325,2928550.9251028164,2244316.5207615616
5,2023-06,2864500.028364429,3664431.3447418325,2928550.9251028164,2244316.5207615616
6,2023-07,2337639.3413016517,3664431.3447418325,2928550.9251028164,2244316.5207615616
7,2023-08,2623919.7900045114,3664431.3447418325,2928550.9251028164,2244316.5207615616
8,2023-09,2622774.8472750857,3664431.3447418325,2928550.9251028164,2244316.5207615616
9,2023-10,2551322.6063154144,3664431.3447418325,2928550.9251028164,2244316.5207615616
10,2023-11,2700103.3821046557,3664431.3447418325,2928550.9251028164,2244316.5207615616
11,2023-12,2928550.9251028164,3664431.3447418325,2928550.9251028164,2244316.5207615616
*/


/* result of second query
index,month,net_revenue,previous_month_revenue,next_month_revenue
0,2022-01,3647525.9238509377,NaN,4840124.874037745
1,2022-02,4840124.874037745,3647525.9238509377,2801554.7220532186
2,2022-03,2801554.7220532186,4840124.874037745,1746624.566563633
3,2022-04,1746624.566563633,2801554.7220532186,4430652.186744979
4,2022-05,4430652.186744979,1746624.566563633,4777313.110382988
5,2022-06,4777313.110382988,4430652.186744979,3395262.6635590964
6,2022-07,3395262.6635590964,4777313.110382988,3698942.6641520704
7,2022-08,3698942.6641520704,3395262.6635590964,3854509.877901427
8,2022-09,3854509.877901427,3698942.6641520704,3913434.519305094
9,2022-10,3913434.519305094,3854509.877901427,3520601.2655624617
10,2022-11,3520601.2655624617,3913434.519305094,4238010.8334873095
11,2022-12,4238010.8334873095,3520601.2655624617,NaN
*/