-- Monthly Net Revenue



WITH monthly_sales AS (
    SELECT
      TO_CHAR(orderdate, 'YYYY-MM') AS order_month,
      SUM(quantity * netprice * exchangerate) AS net_revenue
    FROM sales
    WHERE EXTRACT(YEAR FROM orderdate) = 2023
    GROUP BY order_month
    ORDER BY order_month
)

SELECT
    order_month,
    net_revenue,
    AVG(net_revenue) OVER(ORDER BY order_month ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS moving_avg_3
FROM monthly_sales

/*
index,order_month,net_revenue,moving_avg_3
0,2023-01,3664431.344741833,3664431.344741833
1,2023-02,4465204.568873986,4064817.9568079095
2,2023-03,2244316.520761562,3457984.1447924604
3,2023-04,1162796.1622957806,2624105.7506437763
4,2023-05,2943005.9897180926,2116706.2242584783
5,2023-06,2864500.0283644283,2323434.0601261
6,2023-07,2337639.34130165,2715048.453128057
7,2023-08,2623919.790004511,2608686.3865568633
8,2023-09,2622774.847275086,2528111.3261937485
9,2023-10,2551322.6063154144,2599339.081198337
10,2023-11,2700103.3821046557,2624733.6118983855
11,2023-12,2928550.925102817,2726658.9711742955
*/
