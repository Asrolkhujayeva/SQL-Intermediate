-- Cohort year impact on Yearly Net Revenue


WITH yearly_cohort AS (
  SELECT DISTINCT
    customerkey,
    EXTRACT(YEAR FROM MIN(orderdate) OVER(PARTITION BY customerkey)) AS cohort_year
  FROM sales
)

SELECT 
    y.cohort_year,
    EXTRACT(YEAR FROM orderdate) AS purchase_year,
    SUM(s.quantity * s.netprice * s.exchangerate) AS net_revenue
FROM sales s
LEFT JOIN yearly_cohort y ON s.customerkey = y.customerkey
GROUP BY y.cohort_year, purchase_year



/*
index,cohort_year,purchase_year,net_revenue
0,"""2015""","""2015""",7370979.4818281755
1,"""2015""","""2016""",392623.4779538504
2,"""2015""","""2017""",479841.3074775872
3,"""2015""","""2018""",1069850.8724275753
4,"""2015""","""2019""",1235991.4842707755
5,"""2015""","""2020""",386489.60312098626
6,"""2015""","""2021""",872845.9891434591
7,"""2015""","""2022""",1569787.720036705
8,"""2015""","""2023""",1157633.9105839354
9,"""2015""","""2024""",356186.62302539096
10,"""2016""","""2016""",9990990.195036553
11,"""2016""","""2017""",497028.11248392286
12,"""2016""","""2018""",1074607.2869959206
13,"""2016""","""2019""",1565400.7209625538
14,"""2016""","""2020""",474087.0856289174
15,"""2016""","""2021""",964417.84725164
16,"""2016""","""2022""",2164681.1023622584
17,"""2016""","""2023""",1265242.6277805308
18,"""2016""","""2024""",364066.7599002879
19,"""2017""","""2017""",12244469.63368761
20,"""2017""","""2018""",1407065.1343650885
21,"""2017""","""2019""",1764716.9031457903
22,"""2017""","""2020""",625928.0276185053
23,"""2017""","""2021""",1329858.7232113054
24,"""2017""","""2022""",2428882.801206245
25,"""2017""","""2023""",1714010.1761538933
26,"""2017""","""2024""",464802.56469794764
27,"""2018""","""2018""",21115924.55116603
28,"""2018""","""2019""",3229188.218839007
29,"""2018""","""2020""",1171126.6466615307
30,"""2018""","""2021""",2201262.393492951
31,"""2018""","""2022""",4534295.806294535
32,"""2018""","""2023""",3271753.9180897092
33,"""2018""","""2024""",936833.889219704
34,"""2019""","""2019""",24022798.647577453
35,"""2019""","""2020""",1295044.9866177754
36,"""2019""","""2021""",2337594.7735626674
37,"""2019""","""2022""",4848980.742082018
38,"""2019""","""2023""",3440099.2013718705
39,"""2019""","""2024""",751725.5253685729
40,"""2020""","""2020""",7265759.444863359
41,"""2020""","""2021""",1016399.06884825
42,"""2020""","""2022""",1891708.3985716018
43,"""2020""","""2023""",1435051.0354976407
44,"""2020""","""2024""",312983.0207995898
45,"""2021""","""2021""",12635597.86715813
46,"""2021""","""2022""",3014082.5030587767
47,"""2021""","""2023""",2242369.633143906
48,"""2021""","""2024""",495686.1760247886
49,"""2022""","""2022""",24412138.133988786
50,"""2022""","""2023""",4237220.040533578
51,"""2022""","""2024""",1223450.1242423542
52,"""2023""","""2023""",14345184.963704873
53,"""2023""","""2024""",634143.3693850815
54,"""2024""","""2024""",2856649.3275427963
*/