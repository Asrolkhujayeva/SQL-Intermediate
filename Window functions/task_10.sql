-- Monthly Net Revenue and Month-over-month Growth

%%sql

WITH monthly_revenue AS(
    SELECT 
        TO_CHAR(orderdate, 'YYYY-MM') AS month,
        SUM(quantity * netprice * exchangerate) AS net_revenue
    FROM sales
    WHERE EXTRACT(YEAR FROM orderdate) = 2022
    GROUP BY month
)

SELECT
    *,
    LAG(net_revenue) OVER (ORDER BY month) AS previous_month_revenue,
    (net_revenue - LAG(net_revenue) OVER (ORDER BY month))/LAG(net_revenue) OVER (ORDER BY month) AS monthly_rev_growth
FROM monthly_revenue



/*
index,month,net_revenue,previous_month_revenue,monthly_rev_growth
0,2022-01,3647525.9238509387,NaN,NaN
1,2022-02,4840124.874037763,3647525.9238509387,0.32696106212391696
2,2022-03,2801554.7220532177,4840124.874037763,-0.42118131350687965
3,2022-04,1746624.5665636333,2801554.7220532177,-0.3765516865279868
4,2022-05,4430652.186744998,1746624.5665636333,1.5366940735649959
5,2022-06,4777313.110382985,4430652.186744998,0.07824151141339383
6,2022-07,3395262.6635591034,4777313.110382985,-0.2892945082080011
7,2022-08,3698942.664152082,3395262.6635591034,0.08944227021147294
8,2022-09,3854509.8779014163,3698942.664152082,0.04205721144504285
9,2022-10,3913434.5193051016,3854509.8779014163,0.015287194291941154
10,2022-11,3520601.2655624514,3913434.5193051016,-0.10038068908647653
11,2022-12,4238010.833487315,3520601.2655624514,0.20377472874942293
*/